# 帖子点赞机制文档

## 1. 概述

帖子点赞机制允许用户对社区帖子进行点赞和取消点赞操作，实现了点赞状态的本地管理和服务器同步。

## 2. 技术实现

### 2.1 数据存储

- **服务器端**：
  - **主表**：`community_post`
    - 字段名：`likes`
    - 类型：整数
    - 用途：存储帖子的点赞数量（已弃用，当前直接从community_like表统计）
  
  - **点赞记录表**：`community_like`
    - 字段名：`id`、`post_id`、`user_id`、`created_at`
    - 外键关系：
      - `post_id` → `community_post.id`
      - `user_id` → `normal_user.user_name`
    - 用途：存储每个用户对帖子的点赞记录，当前直接用于统计点赞数量

- **客户端**：
  - 存储方式：localStorage
  - 键名格式：`liked_posts_{userId}`（userId为normal_user.id）
  - 存储内容：用户点赞过的帖子ID数组
  - 用途：保存用户的点赞状态，避免频繁请求服务器
  - 本地状态管理：使用likesCount对象统一管理所有帖子的点赞数量

### 2.2 核心API

#### 2.2.1 toggleLike

**功能**：切换帖子的点赞状态

**参数**：
- `userId` (string)：用户ID（外键关联normal_user.user_name）
- `postId` (string)：帖子ID

**返回值**：
```javascript
{
  success: boolean,
  data: {
    liked: boolean,    // 新的点赞状态
    likes: number      // 新的点赞数量
  },
  error: string|null
}
```

**实现流程**：
1. 检查用户是否已在community_like表中点赞
2. 如果已点赞，删除community_like表中的记录
3. 如果未点赞，在community_like表中添加记录
4. 统计community_like表中该帖子的点赞数量（直接统计，不再更新community_post.likes字段）
5. 更新本地存储中的点赞状态
6. 返回更新后的点赞状态和数量

#### 2.2.3 getLikesByPostId

**功能**：获取帖子的点赞列表

**参数**：
- `postId` (string)：帖子ID

**返回值**：
```javascript
{
  success: boolean,
  data: Array,        // 点赞记录列表
  error: string|null
}
```

**实现流程**：
1. 从community_like表中查询指定帖子的所有点赞记录
2. 关联查询normal_user表，获取点赞用户的信息
3. 按创建时间排序
4. 返回点赞记录列表

#### 2.2.2 getLikeStatus

**功能**：获取帖子的点赞状态

**参数**：
- `userId` (string)：用户ID（外键关联normal_user.user_name）
- `postId` (string)：帖子ID

**返回值**：
```javascript
{
  success: boolean,
  data: {
    liked: boolean,    // 当前点赞状态
    likes: number      // 当前点赞数量
  },
  error: string|null
}
```

**实现流程**：
1. 从community_like表中检查用户是否已点赞
2. 统计community_like表中该帖子的点赞数量
3. 返回点赞状态和数量

## 3. 前端实现

### 3.1 组件：GS_post_list.vue

#### 3.1.1 点赞状态初始化

```javascript
// 如果用户已登录，从本地存储获取点赞状态
if (store.currentUser) {
  const likedPosts = JSON.parse(localStorage.getItem(`liked_posts_${store.currentUser.id}`) || '[]')
  post.liked = likedPosts.includes(post.id)
} else {
  post.liked = false
}

// 初始化点赞数量为0，后续通过loadLikesForPosts获取实际数量
likesCount.value[post.id] = 0
```

#### 3.1.2 点赞事件处理

```javascript
const handleLike = async (postId) => {
  // 检查用户是否登录
  if (!store.currentUser) {
    alert('请先登录后再点赞')
    return
  }
  
  const currentUser = store.currentUser
  const post = posts.value.find(p => p.id === postId)
  
  if (!post) return
  
  try {
  // 乐观更新：立即更新UI，提升用户体验
  const wasLiked = post.liked;
  const currentLikes = likesCount.value[postId] || 0;
  
  // 更新本地UI状态
  post.liked = !wasLiked;
  // 使用likesCount状态而不是post.likes
  likesCount.value[postId] = wasLiked ? Math.max(0, currentLikes - 1) : currentLikes + 1;
  
  // 更新本地存储（仍使用id作为标识，确保用户名改变时点赞状态保持一致）
  const likedPosts = JSON.parse(localStorage.getItem(`liked_posts_${currentUser.id}`) || '[]');
  let updatedLikedPosts;
  if (post.liked) {
    updatedLikedPosts = [...new Set([...likedPosts, postId])];
  } else {
    updatedLikedPosts = likedPosts.filter(id => id !== postId);
  }
  localStorage.setItem(`liked_posts_${currentUser.id}`, JSON.stringify(updatedLikedPosts));
  
  // 保存到本地缓存
  savePostsToCache();
  
  // 异步更新服务器数据（使用user_name作为userId，因为外键关联的是normal_user.user_name）
  const response = await communityAPI.toggleLike(currentUser.user_name, postId);
  
  if (response.success) {
    // 服务器更新成功，更新点赞数量
    likesCount.value[postId] = response.data.likes;
  } else {
    // 服务器更新失败，回滚UI状态
    post.liked = wasLiked;
    likesCount.value[postId] = currentLikes;
    
    // 回滚本地存储
    localStorage.setItem(`liked_posts_${currentUser.id}`, JSON.stringify(likedPosts));
    savePostsToCache();
    alert(response.error || '点赞失败，请稍后重试');
  }
  } catch (error) {
    console.error('点赞出错:', error);
    // 网络错误，回滚UI状态
    post.liked = wasLiked;
    likesCount.value[postId] = currentLikes;
    
    // 回滚本地存储
    localStorage.setItem(`liked_posts_${currentUser.id}`, JSON.stringify(likedPosts));
    savePostsToCache();
    alert('网络错误，请稍后重试');
  }
}
```

### 3.2 模板中的点赞按钮

```vue
<button class="interaction-btn like-btn" :class="{liked: post.liked}" @click="handleLike(post.id)">
  <img class="icon-like normal" src="/WebResources/likes.svg" alt="点赞" />
  <img class="icon-like active" src="/WebResources/likes_click.svg" alt="点赞" />
  <span class="interaction-count">{{ getLikesCount(post.id) }}</span>
</button>
```

## 4. 状态管理

### 4.1 乐观更新

- **实现方式**：点击点赞按钮后立即更新UI和本地存储
- **优点**：提升用户体验，避免等待服务器响应
- **缺点**：需要处理服务器更新失败的情况
- **解决方法**：实现完整的状态回滚机制

### 4.2 状态回滚

当服务器更新失败时，系统会执行以下回滚操作：
1. 恢复UI状态
2. 恢复本地存储中的点赞状态
3. 恢复本地缓存

## 5. 最佳实践

### 5.1 性能优化

- 使用localStorage缓存点赞状态，减少API请求
- 采用乐观更新，提升用户体验
- 合理设置本地缓存的更新频率

### 5.2 错误处理

- 实现完整的错误处理机制
- 提供清晰的用户反馈
- 确保状态一致性

### 5.3 安全性

- 验证用户登录状态
- 防止重复点赞
- 保护API调用安全

## 6. 常见问题

### 6.1 点赞状态不一致

**问题**：不同设备上的点赞状态不一致

**解决方案**：
- 定期与服务器同步点赞状态
- 使用用户ID作为唯一标识，确保跨设备一致性

### 6.2 点赞数量错误

**问题**：点赞数量显示错误

**解决方案**：
- 确保服务器和客户端的点赞数量计算逻辑一致
- 实现定期同步机制

## 7. 未来改进

1. **使用Pinia store**：集中管理点赞状态，提升状态管理的一致性
2. **实现WebSocket同步**：实时同步点赞状态，支持多用户同时点赞
3. **添加点赞动画**：提升用户体验
4. **实现点赞统计**：提供点赞数据统计和分析
5. **添加点赞排行榜**：展示热门帖子

## 8. 版本历史

| 版本 | 日期 | 变更内容 |
|------|------|----------|
| 1.0 | 2025-12-14 | 初始版本 |
| 1.1 | 2025-12-14 | 统一数据库字段名，从like改为likes |
| 1.2 | 2025-12-14 | 统一本地存储标识，使用user.id代替user_name |
| 1.3 | 2025-12-14 | 新增community_like表，单独存储每个用户的点赞记录，参考评论机制实现 |
| 1.4 | 2025-12-14 | 改进点赞机制：<br>- 不再更新community_post.likes字段，直接从community_like表统计点赞数量<br>- 前端使用likesCount对象统一管理点赞数量<br>- 优化乐观更新逻辑<br>- 修复点赞状态同步问题<br>- 改进错误处理和状态回滚机制

## 9. 相关文件

- `src/utils/communityAPI.js`：点赞相关API实现
- `src/componets/GS_post_list.vue`：点赞功能前端实现
- `src/stores/userStore.js`：用户状态管理
